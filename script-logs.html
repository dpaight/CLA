<script>
    function saveLogEntryClient() {
        console.log($("#logEntry").val().toString());
        document.body.style.cursor = "wait";
        if ($("#logEntry").val().toString().length > 0) {
            var logObj = new LogEntry();
            console.log($('entry is gt 0: %s', $("#logEntry").val().toString()));
            // console.log('id and entry are %s and %s', id, entry);
            console.log('saving: %s', JSON.stringify(logObj));

            google.script.run
                .withSuccessHandler(updateLogEntryCache) // server returns the same object
                .saveLogEntryServer(logObj);
        }
        document.body.style.cursor = "default";
        $("#logEntry").val("");
    }
    function logsToCache(allRecords) {
        // console.log('allRecords = %s', allRecords);

        allRecords = JSON.parse(allRecords);
        for (let i = 0; i < allRecords.length; i++) {
            const elAll = allRecords[i];
            // these records have id numbers at 0; within each id number item lies a 2-d array with contact log entries      
            var key = 'reclog' + elAll[0];
            var val = JSON.stringify(elAll[1]);
            sessionStorage.setItem(key, val);
        }
        focus(sessionStorage.getItem("lastId"));
    }
    function openLogPrintDialog() {
        $('#logModal').modal({
            focus: true
        });
        $('#pdfUrl').empty();
        $('#printedLogsth').empty();
        $('#printedLogstb').empty();
        $('#printLogStuName').html('<h4>' + $('#stuName').val() + '</h4>');
        var start = moment().subtract(1, 'y').toDate();
        var end = moment().toDate();
        document.getElementById("endDtEdit").valueAsDate = end;
        document.getElementById("stDtEdit").valueAsDate = start;

        // var logCache = filterLogEntriesByDateWindow();
        // showLog(logEntries, 'loc04');
        filterLogEntriesByDateWindow();
        // $('#spinner02').hide();
    }
    function showLog(logEntries, loc) { // [entries, id]
        // input is an array containing one arrays and one string ('loc'): array contains all the log entries that correspond to that record
        //     console.log('in "showLog" the first log entry is: %s; the loc is %s', JSON.stringify(logEntries[0]), loc);
        //     console.log('logEntries is a type of %s', typeof logEntries);
        if (typeof logEntries == 'string') {
            logEntries = JSON.parse(logEntries);
        }

        var list = $("#" + loc);
        list.empty();

        var stuName = First_Name + ' ' + Last_Name;
        for (var i = 0; i < logEntries.length; i++) {
            var el = logEntries[i];
            var [
                Timestamp, email, studentMC, log_entry, logId, seis_id, Last_Name, First_Name, First_Name, Student_ID
            ] = el;
            list.append(
                '<tr class="d-flex">' +
                '<td data-entry_id=' +
                logId + ' class="col-3 logEntry"' + 'data-toggle="tooltip" data-placement="right" ' +
                'title= "double-click to edit">' +
                moment(el[0]).format("YYYY-MM-DD") +
                '</td>' +
                '<td data-entry_id=' + logId + ' class="logEntry col-9">' +
                el[3] +
                '</td>' +
                '</tr>'
            );
        }
        $("#corrlng[value='01']", function () {
            $(this).css("background-color", "#ff0000")
        });

        $("#" + 'loc01' + "tb").show();

        document.body.style.cursor = "default";

    }

    function saveEditedLogEntryClient(remove) {
        if (remove == true) { 
            if (confirm("Are you sure you want to remove this log entry?") == false) {
                return;
            };
        }
        var entry = $("#editEntry").val();
        var date = $("#editDate").val();
        var id = $("#editId").val();
        var nmjdob = $("#nmjdob").val();
        var seis_id = $("#seis_id").val();

        console.log('vars %s; %s; %s; %s; %s; ', entry, date, id, nmjdob, seis_id);
        var logObj = {
            "logEntry": entry,
            "logDate": date,
            "logId": id,
            "nmjdob": nmjdob,
            "seis_id": seis_id,
            "remove": remove
        }
        console.log('logObj: %s', JSON.stringify(logObj));

        google.script.run
            .withSuccessHandler(saveLogEntrySuccess)
            .saveEditedLogEntryServer(JSON.stringify(logObj));

    }
    function saveLogEntrySuccess(logObjStr) {
        var logObj = JSON.parse(logObjStr);
        console.log('returned at saveLogEntrySuccess: %s', logObjStr);
        sessionStorage.removeItem('reclog' + logObj.seis_id.toString());
        focus(logObj.seis_id.toString(), 'loc01');
    }

    function LogEntry() {
        // as passed from jquery function or from log entry editor (in the former case, there will be no logId value)
        //  log-entry-obj = 
        //  {
        //     "seis_id": id,
        //     "logEntry": entry,
        //     "nmjdob": nmjdob,
        //     "logId": 
        //  }
        this.logEntry = $("#logEntry").val();
        this.logId = null;
        this.seis_id = $("#seis_id").val().toString();
        this.nmJdob = $("#nmjdob").val().toString();
        return this;
    }
    function updateLogEntryCache(array) {
        var [logObjStr, cacheRow] = array;
        var logObj = JSON.parse(logObjStr);
        console.log('caching...logObj is %s', JSON.stringify(logObj));

        var logCache = JSON.parse(sessionStorage.getItem('reclog' + logObj.seis_id));
        logCache.unshift(JSON.parse(cacheRow));
        sessionStorage.setItem('reclog' + logObj.seis_id, JSON.stringify(logCache));

        refreshLogDisplay(logCache, 'loc01');
    }
    function refreshLogDisplay(logCache, loc) { // [entries, id]
        var list = $("#" + loc);
        list.empty();

        for (var i = 0; i < logCache.length; i++) {
            var el = logCache[i];
            var [
                Timestamp, email, studentMC, log_entry, logId, seis_id, Last_Name, First_Name, First_Name, Student_ID
            ] = el;
            list.append(
                '<tr class="d-flex">' +
                '<td data-entry_id=' +
                logId + ' class="col-3 logEntry"' + 'data-toggle="tooltip" data-placement="right" ' +
                'title= "double-click to edit">' +
                moment(el[0]).format("YYYY-MM-DD") +
                '</td>' +
                '<td data-entry_id=' + logId + ' class="logEntry col-9">' +
                el[3] +
                '</td>' +
                '</tr>'
            );
        }
        $("#corrlng[value='01']", function () {
            $(this).css("background-color", "#ff0000")
        });

        $("#" + 'loc01' + "tb").show();

        document.body.style.cursor = "default";

    }
// function editLogEntryInModal(logObjStr){
//     logObj = JSON.stringify(logObjStr);
//     var myModal = new bootstrap.Modal(document.getElementById('logModal'), { focus: true });
// "seis_id": seis_id,
// "logEntry": logEntry,
// "nmjdob": nmjdob,
// "logId": logId

//     $('#seis_id').val(logObj.seis_id);
//     $('#glEditLvl').val();
//     $('#glEditStrand').val(goal.strand);
//     myModal.show();

// }
</script>